# snipper
A powerful rule engine and behavior tree system for intelligent automation and control

## 项目简介

snipper是一个功能强大的智能自动化控制系统，集成了规则引擎、行为树系统、条件表达式引擎和优先级管理等功能。它能够解析JSON配置文件来执行复杂的自动化任务，支持机器人控制、智能交通、工业自动化等多种应用场景。

### 核心组件

- **snipper**: 主程序，基于多线程架构的规则引擎运行时
- **groot**: 图形界面编辑器，用于编辑task.json配置文件（开发中）
- **runtime**: 模块化运行时引擎，包含规则引擎、行为树系统、条件评估和动作执行

### 主要特性

- 🚀 **高性能规则引擎**: 支持复杂条件评估和动作执行
- 🌳 **行为树系统**: 适用于机器人控制、游戏AI等复杂决策场景
- 🧮 **条件表达式增强**: 支持数学运算、逻辑运算、字符串操作、时间条件
- ⚡ **优先级管理**: 支持规则优先级排序和依赖关系管理
- 🔄 **多线程架构**: 高效的并发执行和实时响应
- 📊 **历史数据支持**: 支持历史数据查询和趋势分析
- 🎯 **实际应用案例**: 清洁机器人、路口红绿灯、多条件数据回传等

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        snipper                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Engine    │  │  BTManager  │  │   Context   │        │
│  │ (规则引擎)   │  │ (行为树管理) │  │ (上下文管理) │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│           │               │               │                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Condition  │  │ Expression  │  │  Priority   │        │
│  │ (条件评估)   │  │ (表达式引擎) │  │ (优先级管理) │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│           │               │               │                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Behavior Tree System                      │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │ │
│  │  │ Action  │ │Condition│ │Sequence │ │Selector │      │ │
│  │  │ Nodes   │ │ Nodes   │ │ Nodes   │ │ Nodes   │      │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 当前功能

- ✅ 规则引擎核心功能
- ✅ 多线程架构（runtime、update、execute线程）
- ✅ JSON配置解析
- ✅ 条件评估（支持复合条件：all、any）
- ✅ 动作注册和执行
- ✅ 规则节流控制
- ✅ 多种比较操作符（==、!=、>、<、>=、<=）
- ✅ 条件表达式增强（数学运算、逻辑运算、字符串操作、时间条件、历史数据）
- ✅ 规则优先级和依赖管理系统
- ✅ 行为树（Behavior Tree）支持
- ✅ 模块化运行时架构
- ✅ 静态库编译支持

## 功能扩展计划

### 1. 条件表达式增强 ✅ 已完成
- ✅ 数学运算：+, -, *, /, %
- ✅ 逻辑运算：&&, ||, !
- ✅ 字符串操作：contains, starts_with, ends_with
- ✅ 时间条件：time_between, day_of_week
- ✅ 历史数据：avg_last_n, max_last_n, trend

### 2. 规则优先级和依赖管理 ✅ 已完成
- ✅ 规则优先级系统
- ✅ 规则依赖关系（A规则依赖B规则完成）
- ✅ 规则组和命名空间
- ✅ 规则启用/禁用控制

### 3. 行为树系统 ✅ 已完成
- ✅ 行为树节点类型（Action、Condition、Sequence、Selector、Parallel等）
- ✅ 行为树解析器（JSON配置支持）
- ✅ 行为树执行器（状态管理：SUCCESS、FAILURE、RUNNING）
- ✅ 行为树管理器（集成到运行时）
- ✅ 实际应用案例（清洁机器人、路口红绿灯、多条件任务）

### 4. 数据持久化和状态管理
- [ ] 规则执行历史记录
- [ ] 传感器数据历史存储
- [ ] 规则状态持久化
- [ ] 配置热重载

### 5. 错误处理和监控
- [ ] 规则执行失败重试机制
- [ ] 动作执行超时控制
- [ ] 详细的日志记录系统
- [ ] 健康检查和监控指标

### 6. 高级调度功能
- [ ] 定时规则（cron表达式）
- [ ] 延迟执行和定时器
- [ ] 规则执行频率限制
- [ ] 资源使用监控

### 7. 网络和外部集成
- [ ] HTTP API接口
- [ ] WebSocket实时通信
- [ ] MQTT消息订阅
- [ ] 数据库连接器
- [ ] 外部服务调用

### 8. 安全和权限管理
- [ ] 动作执行权限控制
- [ ] 规则修改权限验证
- [ ] 敏感数据加密
- [ ] 审计日志

### 9. 性能优化
- [ ] 规则执行缓存
- [ ] 条件预编译
- [ ] 批量数据处理
- [ ] 内存使用优化


## 新增功能详解

### 条件表达式增强
支持复杂的条件表达式，包括数学运算、逻辑运算、字符串操作、时间条件和历史数据查询：

```json
{
    "when": {
        "expression": "(temp > 25) && (humidity < 60) && contains(weather, 'sunny')"
    }
}
```

### 规则优先级系统
支持规则优先级排序和依赖管理：

```json
{
    "rules": [
        {
            "id": "emergency_rule",
            "priority": 100,
            "depends_on": ["sensor_check"],
            "when": {"left": "emergency", "op": "==", "right": true},
            "do": [{"action": "emergency_stop"}]
        }
    ]
}
```

### 行为树系统
支持复杂的行为树逻辑，适用于机器人控制、游戏AI等场景：

```json
{
    "root": {
        "type": "sequence",
        "children": [
            {
                "type": "condition",
                "condition": "check_battery",
                "params": {"threshold": 20}
            },
            {
                "type": "action",
                "action": "return_to_charge"
            }
        ]
    }
}
```

### 实际应用案例
- **清洁机器人任务** (`clean_robot_task.json`): 实现机器人清扫、充电、避障等复杂行为
- **路口红绿灯控制** (`junction_light_task.json`): 实现标准红绿灯循环控制
- **多条件数据回传** (`multi_condition_task.json`): 实现多条件组合的单一动作执行

## 安装依赖

项目依赖以下库：
- **nlohmann/json**: JSON解析库（通过FetchContent自动获取）
- **CMake 3.16+**: 构建系统
- **C++17**: 编程语言标准

## 快速开始

### 1. 构建项目
```bash
# 克隆项目
git clone <repository-url>
cd snipper

# 构建项目
mkdir build && cd build
cmake ..
make

# 构建测试程序
cd ..
./test/build_tests.sh
```

### 2. 运行示例
```bash
# 运行清洁机器人任务
./test/bin/test_clean_robot

# 运行路口红绿灯任务
./test/bin/test_junction_light

# 运行多条件数据回传任务
./test/bin/test_multi_condition

# 运行行为树示例
./test/bin/test_behavior_tree
```

### 3. 使用规则引擎
```bash
# 运行主程序
cp ../task.json .
./bin/snipper

# 运行图形编辑器（开发中）
./bin/groot
```

## 测试

项目包含完整的测试套件，位于 `test/` 目录：

```bash
# 构建测试程序
./test/build_tests.sh

# 运行所有测试
./test/run_tests.sh

# 清理测试文件
rm -rf test/bin
```

### 测试覆盖范围
- ✅ 基础功能测试
- ✅ 规则优先级系统
- ✅ 规则组管理
- ✅ 条件评估
- ✅ 动作执行
- ✅ 多线程架构
- ✅ 条件表达式增强
- ✅ 行为树系统
- ✅ 清洁机器人任务
- ✅ 路口红绿灯控制
- ✅ 多条件数据回传

## 配置文件示例

```json
{
    "rules": [
        {
            "id": "r1",
            "when": {
                "all": [
                    {"left": "temp", "op": ">", "right": 40},
                    {"left": "door", "op": "==", "right": "open"}
                ]
            },
            "do": [
                {"action": "fan_on", "params": {"level": 3}},
                {"action": "notify", "params": {"text": "High temp with door open"}}
            ],
            "mode": "repeat",
            "throttle_ms": 1000
        }
    ]
}
```

## 开发状态

- [x] 基础规则引擎
- [x] 多线程架构
- [x] JSON配置解析
- [x] 条件评估系统
- [x] 动作执行框架
- [x] 规则优先级系统
- [x] 条件表达式增强
- [x] 行为树系统
- [x] 模块化运行时架构
- [x] 静态库编译支持
- [x] 实际应用案例（清洁机器人、红绿灯、多条件任务）
- [ ] 图形界面编辑器（groot）
- [ ] 数据持久化
- [ ] 网络API接口

